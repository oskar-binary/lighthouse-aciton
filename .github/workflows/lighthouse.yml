name: Deriv Lighthouse Audit

on:
  issue_comment:
    types: [edited]

jobs:
  generate_lighthouse_audit:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Capture Vercel preview URL
        id: vercel_preview_url
        uses: aaron-binary/vercel-preview-url-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
      - name: Audit preview URL with ligthhouse
        id: lighthouse_audit
        uses: treosh/lighthouse-ci-action@v3
        with:
          urls: |
            ${{ steps.vercel_preview_url.outputs.vercel_preview_url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
      - name: Comment on pull request with Lighthouse audit score
        id: comment_on_pr
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const comment_lines = [
                "üçø Lighthouse report for the changes in this PR",
                `
                | Category | Score |
                    | --- | --- |
                  | Performance | ${{steps.lighthouse_audit.outputs.manifest.summary.performance}}|
                  | Accessibility | ${{steps.lighthouse_audit.outputs.manifest.summary.accessibility}} |
                  | Best practices | ${{steps.lighthouse_audit.outputs.manifest.summary['best-practices']}} |
                  | SEO | ${{steps.lighthouse_audit.outputs.manifest.summary.seo}} |
                  | PWA | ${{steps.lighthouse_audit.outputs.manifest.summary.pwa}} |
                `,
            ];
            github.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment_lines.join('\n'),
            });
