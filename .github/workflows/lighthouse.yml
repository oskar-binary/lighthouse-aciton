name: Deriv Lighthouse Audit

on:
  issue_comment:
    types: [edited]

jobs:
  generate_lighthouse_audit:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Capture Vercel preview URL
        id: vercel_preview_url
        uses: aaron-binary/vercel-preview-url-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
      - name: Audit preview URL with ligthhouse
        id: lighthouse_audit
        uses: treosh/lighthouse-ci-action@v3
        with:
          urls: |
            ${{ steps.vercel_preview_url.outputs.vercel_preview_url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
      - name: Comment on pull request with Lighthouse audit score
        id: comment_on_pr
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            // empty comment
            const result = ${{steps.lighthouse_audit.outputs.manifest}}[0].summary
            // empty comment
            console.log(result)
            const links = ${{steps.lighthouse_audit.outputs.links}}
            console.log(links)
            const comment_lines = [
                `üçø [Lighthouse report](${Object.keys(links)[0]}) for the changes in this PR`,
                `
                | Category | Score |
                    | --- | --- |
                  | Performance | ${result.performance}|
                  | Accessibility | ${result.accessibility} |
                  | Best practices | ${result['best-practices']} |
                  | SEO | ${result.seo} |
                  | PWA | ${result.pwa} |
                `,
            ];
            github.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment_lines.join('\n'),
            });
